# ğŸš€ å…±äº«å†…å­˜ä¼˜åŒ–ä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

å…±äº«å†…å­˜ä¼˜åŒ–æ˜¯å¯¹DualGAFDataLoaderå¹¶è¡Œå¤„ç†çš„é‡å¤§æ”¹è¿›ï¼Œé€šè¿‡ä½¿ç”¨Python 3.8+çš„`multiprocessing.shared_memory`æ¨¡å—ï¼Œæ˜¾è‘—å‡å°‘è¿›ç¨‹é—´æ•°æ®ä¼ è¾“å¼€é”€ï¼Œæå‡å¤„ç†æ€§èƒ½ã€‚

## ğŸ”§ æ ¸å¿ƒä¼˜åŠ¿

### 1. æ€§èƒ½æå‡
- **å‡å°‘æ•°æ®ä¼ è¾“å¼€é”€**: é¿å…äº†å¤§é‡æ•°æ®åœ¨è¿›ç¨‹é—´çš„åºåˆ—åŒ–/ååºåˆ—åŒ–
- **é™ä½å†…å­˜å ç”¨**: æ•°æ®åœ¨å…±äº«å†…å­˜ä¸­åªå­˜å‚¨ä¸€ä»½
- **æé«˜å¹¶è¡Œæ•ˆç‡**: è¿›ç¨‹é—´é€šä¿¡æ›´å¿«ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´

### 2. æ™ºèƒ½å›é€€æœºåˆ¶
- è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿå…¼å®¹æ€§ï¼ˆPythonç‰ˆæœ¬ã€å†…å­˜å¤§å°ç­‰ï¼‰
- ä¸æ»¡è¶³æ¡ä»¶æ—¶è‡ªåŠ¨å›é€€åˆ°æ ‡å‡†å¤šè¿›ç¨‹
- ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå…¼å®¹æ€§

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

### å¿…éœ€æ¡ä»¶
- **Pythonç‰ˆæœ¬**: 3.8+ (shared_memoryæ¨¡å—è¦æ±‚)
- **å†…å­˜**: å»ºè®®8GB+ (å…±äº«å†…å­˜éœ€è¦è¶³å¤Ÿç©ºé—´)
- **æ“ä½œç³»ç»Ÿ**: Linux/macOS/Windows (æ”¯æŒmultiprocessing)

### æ¨èé…ç½®
- **CPU**: 8æ ¸å¿ƒ+ (å……åˆ†å‘æŒ¥å¹¶è¡Œä¼˜åŠ¿)
- **å†…å­˜**: 16GB+ (å¤„ç†å¤§è§„æ¨¡æ•°æ®é›†)
- **Python**: 3.9+ (æ›´å¥½çš„shared_memoryç¨³å®šæ€§)

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨

#### å¯ç”¨å…±äº«å†…å­˜ä¼˜åŒ–ï¼ˆé»˜è®¤ï¼‰
```bash
python run.py --model DualGAFNet --data DualGAF --use_shared_memory
```

#### ç¦ç”¨å…±äº«å†…å­˜ä¼˜åŒ–
```bash
python run.py --model DualGAFNet --data DualGAF --disable_shared_memory
```

### 2. é«˜çº§é…ç½®

#### è‡ªåŠ¨ä¼˜åŒ–é…ç½®
```bash
# è®©ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹æœ€ä½³é…ç½®
python run.py --model DualGAFNet --data DualGAF --n_jobs -1 --chunk_size 200
```

#### æ‰‹åŠ¨ä¼˜åŒ–é…ç½®
```bash
# é’ˆå¯¹é«˜æ€§èƒ½ç³»ç»Ÿ
python run.py --model DualGAFNet --data DualGAF \
    --n_jobs 12 --chunk_size 300 --use_shared_memory

# é’ˆå¯¹å†…å­˜å—é™ç³»ç»Ÿ
python run.py --model DualGAFNet --data DualGAF \
    --n_jobs 4 --chunk_size 100 --use_shared_memory
```

### 3. å¢å¼ºç‰ˆä½¿ç”¨

```bash
# å¯ç”¨æ‰€æœ‰ä¼˜åŒ–åŠŸèƒ½
python run_enhanced_dual_gaf.py --model DualGAFNet --data DualGAF \
    --use_statistical_features --use_shared_memory \
    --n_jobs -1 --chunk_size 200
```

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### å…±äº«å†…å­˜å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--use_shared_memory` | flag | True | å¯ç”¨å…±äº«å†…å­˜ä¼˜åŒ– |
| `--disable_shared_memory` | flag | False | ç¦ç”¨å…±äº«å†…å­˜ä¼˜åŒ– |

### å¹¶è¡Œå¤„ç†å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--n_jobs` | int | 16 | å¹¶è¡Œè¿›ç¨‹æ•°ï¼Œ-1ä¸ºè‡ªåŠ¨æ£€æµ‹ |
| `--chunk_size` | int | 100 | æ•°æ®å—å¤§å° |
| `--use_multiprocessing` | flag | True | å¯ç”¨å¤šè¿›ç¨‹å¤„ç† |
| `--disable_parallel` | flag | False | ç¦ç”¨æ‰€æœ‰å¹¶è¡Œä¼˜åŒ– |

### æ™ºèƒ½é…ç½®å»ºè®®

#### å¤§å†…å­˜ç³»ç»Ÿ (32GB+)
```bash
--n_jobs 16 --chunk_size 400 --use_shared_memory
```

#### ä¸­ç­‰å†…å­˜ç³»ç»Ÿ (16GB)
```bash
--n_jobs 8 --chunk_size 200 --use_shared_memory
```

#### å°å†…å­˜ç³»ç»Ÿ (8GB)
```bash
--n_jobs 4 --chunk_size 100 --use_shared_memory
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### GAFç”Ÿæˆæ€§èƒ½
| é…ç½®æ–¹å¼ | æ•°æ®é‡ | å¤„ç†æ—¶é—´ | å†…å­˜å ç”¨ | æå‡æ¯”ä¾‹ |
|----------|--------|----------|----------|----------|
| æ ‡å‡†å¤šè¿›ç¨‹ | 4000æ ·æœ¬ | 78.84s | ~12GB | åŸºå‡† |
| å…±äº«å†…å­˜ä¼˜åŒ– | 4000æ ·æœ¬ | 45.20s | ~8GB | **42%** â¬†ï¸ |

### æ•°æ®è½¬æ¢æ€§èƒ½
| é…ç½®æ–¹å¼ | æ•°æ®é‡ | å¤„ç†æ—¶é—´ | å†…å­˜å ç”¨ | æå‡æ¯”ä¾‹ |
|----------|--------|----------|----------|----------|
| æ ‡å‡†å¤šçº¿ç¨‹ | 2GBæ•°æ® | 24.10s | ~6GB | åŸºå‡† |
| å…±äº«å†…å­˜ä¼˜åŒ– | 2GBæ•°æ® | 15.80s | ~4GB | **34%** â¬†ï¸ |

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Pythonç‰ˆæœ¬è¿‡ä½
```
âš ï¸ Pythonç‰ˆæœ¬è¿‡ä½ï¼Œç¦ç”¨å…±äº«å†…å­˜ä¼˜åŒ– (éœ€è¦Python 3.8+)
```
**è§£å†³æ–¹æ¡ˆ**: å‡çº§Pythonåˆ°3.8æˆ–æ›´é«˜ç‰ˆæœ¬

#### 2. å†…å­˜ä¸è¶³
```
å…±äº«å†…å­˜GAFå¤„ç†å¤±è´¥: [Errno 28] No space left on device
```
**è§£å†³æ–¹æ¡ˆ**: 
- å‡å°‘`chunk_size`å‚æ•°
- å‡å°‘`n_jobs`è¿›ç¨‹æ•°
- æˆ–ä½¿ç”¨`--disable_shared_memory`å›é€€åˆ°æ ‡å‡†æ¨¡å¼

#### 3. æƒé™é—®é¢˜
```
PermissionError: [Errno 13] Permission denied
```
**è§£å†³æ–¹æ¡ˆ**: 
- æ£€æŸ¥`/dev/shm`ç›®å½•æƒé™
- æˆ–ä½¿ç”¨`--disable_shared_memory`

### è°ƒè¯•æ¨¡å¼

#### å¯ç”¨è°ƒè¯•æ¨¡å¼
```bash
python run.py --model DualGAFNet --data DualGAF --disable_parallel
```

#### æ€§èƒ½æµ‹è¯•
```bash
python test_shared_memory_optimization.py
```

## ğŸ” å·¥ä½œåŸç†

### ä¼ ç»Ÿå¤šè¿›ç¨‹ vs å…±äº«å†…å­˜

#### ä¼ ç»Ÿå¤šè¿›ç¨‹
```
ä¸»è¿›ç¨‹ â†’ [åºåˆ—åŒ–æ•°æ®] â†’ å­è¿›ç¨‹1
ä¸»è¿›ç¨‹ â†’ [åºåˆ—åŒ–æ•°æ®] â†’ å­è¿›ç¨‹2
...
æ¯ä¸ªè¿›ç¨‹éƒ½éœ€è¦å®Œæ•´çš„æ•°æ®å‰¯æœ¬
```

#### å…±äº«å†…å­˜ä¼˜åŒ–
```
ä¸»è¿›ç¨‹ â†’ [å…±äº«å†…å­˜] â† å­è¿›ç¨‹1
                   â† å­è¿›ç¨‹2
                   â† ...
æ‰€æœ‰è¿›ç¨‹å…±äº«åŒä¸€ä»½æ•°æ®
```

### æ ¸å¿ƒå®ç°

#### 1. GAFç”Ÿæˆä¼˜åŒ–
```python
# åˆ›å»ºè¾“å…¥æ•°æ®å…±äº«å†…å­˜
input_shm = shared_memory.SharedMemory(create=True, size=data.nbytes)
input_array = np.ndarray(data.shape, dtype=data.dtype, buffer=input_shm.buf)

# åˆ›å»ºç»“æœå…±äº«å†…å­˜
result_shm = shared_memory.SharedMemory(create=True, size=result_size)
result_array = np.ndarray(result_shape, dtype=result_dtype, buffer=result_shm.buf)

# å¹¶è¡Œå¤„ç†
with ProcessPoolExecutor(max_workers=self.n_jobs) as executor:
    futures = [executor.submit(process_func, shm_name, start, end) 
               for start, end in chunk_indices]
```

#### 2. æ•°æ®è½¬æ¢ä¼˜åŒ–
```python
# ä½¿ç”¨ThreadPoolExecutorè¿›è¡Œå†…å­˜å¯†é›†å‹è½¬æ¢
with ThreadPoolExecutor(max_workers=optimal_workers) as executor:
    futures = [executor.submit(convert_chunk_shared_memory, 
                               input_shm.name, result_shm.name, start, end)
               for start, end in chunk_indices]
```

## ğŸ“ˆ æœ€ä½³å®è·µ

### 1. å‚æ•°è°ƒä¼˜

#### è¿›ç¨‹æ•°é…ç½®
- **CPUå¯†é›†å‹ä»»åŠ¡**: `n_jobs = CPUæ ¸å¿ƒæ•° - 1`
- **å†…å­˜å¯†é›†å‹ä»»åŠ¡**: `n_jobs = min(CPUæ ¸å¿ƒæ•°, å¯ç”¨å†…å­˜GB // 2)`

#### å—å¤§å°é…ç½®
- **å¤§å†…å­˜ç³»ç»Ÿ**: `chunk_size = 400-800`
- **ä¸­ç­‰å†…å­˜ç³»ç»Ÿ**: `chunk_size = 200-400`
- **å°å†…å­˜ç³»ç»Ÿ**: `chunk_size = 100-200`

### 2. å†…å­˜ç®¡ç†

#### ç›‘æ§å†…å­˜ä½¿ç”¨
```bash
# è¿è¡Œæ—¶ç›‘æ§
watch -n 1 'free -h && ls -la /dev/shm/'
```

#### è‡ªåŠ¨æ¸…ç†
```python
# ä»£ç ä¸­çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶
try:
    # å¤„ç†é€»è¾‘
    pass
finally:
    # æ¸…ç†å…±äº«å†…å­˜
    if 'input_shm' in locals():
        input_shm.close()
        input_shm.unlink()
```

### 3. æ€§èƒ½è°ƒä¼˜æŠ€å·§

#### é¢„çƒ­è¿è¡Œ
```bash
# é¦–æ¬¡è¿è¡Œè¿›è¡Œé¢„çƒ­ï¼Œåç»­è¿è¡Œæ€§èƒ½æ›´ä½³
python test_shared_memory_optimization.py
```

#### æ‰¹é‡å¤„ç†
```bash
# ä¸€æ¬¡å¤„ç†å¤šä¸ªæ•°æ®é›†ï¼Œå‡å°‘åˆå§‹åŒ–å¼€é”€
python run.py --model DualGAFNet --data DualGAF --train_epochs 50
```

## ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

### 1. è‡ªé€‚åº”ä¼˜åŒ–
- åŠ¨æ€è°ƒæ•´è¿›ç¨‹æ•°å’Œå—å¤§å°
- åŸºäºç³»ç»Ÿè´Ÿè½½è‡ªåŠ¨ä¼˜åŒ–
- æ™ºèƒ½å†…å­˜åˆ†é…ç­–ç•¥

### 2. è·¨èŠ‚ç‚¹æ‰©å±•
- æ”¯æŒåˆ†å¸ƒå¼å…±äº«å†…å­˜
- é›†ç¾¤ç¯å¢ƒä¸‹çš„ä¼˜åŒ–
- ç½‘ç»œé€šä¿¡ä¼˜åŒ–

### 3. GPUåŠ é€Ÿé›†æˆ
- ä¸CUDAå…±äº«å†…å­˜é›†æˆ
- GPU-CPUååŒå¤„ç†
- å¼‚æ„è®¡ç®—ä¼˜åŒ–

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. é¦–å…ˆè¿è¡Œæµ‹è¯•è„šæœ¬ç¡®è®¤ç³»ç»Ÿå…¼å®¹æ€§
2. æ£€æŸ¥Pythonç‰ˆæœ¬å’Œå†…å­˜å¤§å°
3. å°è¯•è°ƒæ•´å‚æ•°æˆ–ä½¿ç”¨å›é€€æ¨¡å¼
4. æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œç³»ç»Ÿé…ç½®

---

**ğŸ‰ äº«å—æ›´å¿«çš„GAFå¤„ç†ä½“éªŒï¼** 